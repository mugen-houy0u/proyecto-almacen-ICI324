---
/**
 * P√°gina: Admin / Proveedores
 * Notas:
 * - 100% frontend. No depende de backend para funcionar.
 * - Usa html2pdf.js por CDN para exportar el √°rea de la factura a PDF.
 * - Cuando el backend est√© listo, los TODO: fetch(...) se conectan a tus APIs.
 */
const title = "Proveedores ‚Äì Admin";
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tipograf√≠as y estilos b√°sicos para que el PDF salga limpio -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
      :root{ --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --brand:#0ea5e9;}
      *{ box-sizing:border-box; }
      body{ font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); margin:0; background:#fafafa;}
      .container{ max-width:1100px; margin:32px auto; padding:0 16px;}
      h1{ font-size:1.4rem; margin:0 0 16px; }
      .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
      .grid{ display:grid; gap:12px; }
      .grid.cols-2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .grid.cols-3{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
      label{ font-size:.85rem; color:var(--muted); display:block; margin-bottom:6px;}
      input, select{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; }
      input:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(14,165,233,.15); }
      table{ width:100%; border-collapse:collapse; }
      th, td{ border-bottom:1px solid var(--line); padding:10px; font-size:.92rem; text-align:left; }
      th{ background:#f9fafb; font-weight:600; color:#374151; position:sticky; top:0; }
      tfoot td{ font-weight:600; }
      .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; }
      .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand); }
      .btn.danger{ color:#ef4444; border-color:#fecaca; }
      .toolbar{ display:flex; gap:8px; flex-wrap:wrap; }
      .mt-2{ margin-top:8px; } .mt-3{ margin-top:12px; } .mt-4{ margin-top:16px; } .mt-6{ margin-top:24px; }
      .right{ text-align:right; }
      /* √Årea que se exporta a PDF */
      .invoice{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:20px; }
      .invoice header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
      .invoice h2{ margin:0; font-size:1.1rem; }
      .badge{ border:2px solid #ef4444; color:#ef4444; padding:8px 12px; border-radius:8px; font-weight:700; }
      .muted{ color:var(--muted); }
      .small{ font-size:.85rem; }
      .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Admin / Proveedores</h1>

      <!-- Formulario principal -->
      <section class="card grid cols-3">
        <div>
          <label for="rut">RUT</label>
          <input id="rut" name="rut" placeholder="76.667.791-6" autocomplete="off" />
        </div>
        <div>
          <label for="nombre">Nombre Raz√≥n Social</label>
          <input id="nombre" name="nombre" placeholder="WebFactura SPA" />
        </div>
        <div>
          <label for="correo">Correo</label>
          <input id="correo" name="correo" type="email" placeholder="contacto@dominio.cl" />
        </div>
        <div>
          <label for="giro">Giro (opcional)</label>
          <input id="giro" name="giro" placeholder="Comercio al por menor" />
        </div>
        <div>
          <label for="fechaEmision">Fecha emisi√≥n</label>
          <input id="fechaEmision" name="fechaEmision" type="date" />
        </div>
        <div>
          <label for="formaPago">Forma de pago</label>
          <select id="formaPago" name="formaPago">
            <option value="Contado">Contado</option>
            <option value="Cr√©dito">Cr√©dito</option>
          </select>
        </div>
      </section>

      <!-- Tabla de productos -->
      <section class="card mt-4">
        <div class="toolbar">
          <button id="addRow" class="btn">+ Agregar producto</button>
          <button id="clearRows" class="btn danger">Vaciar</button>
          <div class="muted small">Campos: N¬∞, Descripci√≥n, Cantidad, U.M, Precio, %Imp, %Desc</div>
        </div>

        <div class="mt-3" style="overflow:auto; max-height:50vh;">
          <table id="itemsTable">
            <thead>
              <tr>
                <th style="width:70px;">N¬∞</th>
                <th>Descripci√≥n</th>
                <th style="width:110px;">Cantidad</th>
                <th style="width:90px;">U.M</th>
                <th style="width:130px;">Precio</th>
                <th style="width:110px;">% Imp.</th>
                <th style="width:120px;">% Desc.</th>
                <th class="right" style="width:140px;">Total</th>
                <th style="width:60px;"></th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
            <tfoot>
              <tr>
                <td colspan="7" class="right">Subtotal</td>
                <td class="right mono" id="subtotalCell">$0</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="7" class="right">Impuestos</td>
                <td class="right mono" id="taxCell">$0</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="7" class="right">Descuentos</td>
                <td class="right mono" id="discCell">-$0</td>
                <td></td>
              </tr>
              <tr>
                <td colspan="7" class="right">Total factura</td>
                <td class="right mono" id="grandCell">$0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <div class="mt-4 toolbar">
        <button id="generatePdf" class="btn primary">üßæ Generar factura (PDF)</button>
        <!-- Botones opcionales de integraci√≥n futura -->
        <button id="saveDraft" class="btn">Guardar borrador (API)</button>
      </div>

      <!-- Vista ‚Äúbonita‚Äù de la factura: esto es lo que se exporta a PDF -->
      <section class="invoice mt-6" id="invoice">
        <header>
          <div>
            <div class="small muted">PRUEBA</div>
            <h2>Factura</h2>
            <div class="small">Emisor demo ‚Äî www.demo.cl ‚Äî +56 55 5555</div>
          </div>
          <div class="badge">FACTURA ELECTR√ìNICA</div>
        </header>

        <div class="grid cols-2 small">
          <div>
            <div><strong>Se√±or(es):</strong> <span id="i_nombre">‚Äî</span></div>
            <div><strong>R.U.T.:</strong> <span id="i_rut">‚Äî</span></div>
            <div><strong>Giro:</strong> <span id="i_giro">‚Äî</span></div>
            <div><strong>Correo:</strong> <span id="i_correo">‚Äî</span></div>
          </div>
          <div>
            <div><strong>Fecha emisi√≥n:</strong> <span id="i_fecha">‚Äî</span></div>
            <div><strong>Forma de pago:</strong> <span id="i_pago">‚Äî</span></div>
          </div>
        </div>

        <div class="mt-3" style="overflow:hidden;">
          <table>
            <thead>
              <tr>
                <th>N¬∞</th>
                <th>Descripci√≥n</th>
                <th>Cantidad</th>
                <th>U.M</th>
                <th>Precio</th>
                <th>% Imp.</th>
                <th>% Desc.</th>
                <th class="right">Total</th>
              </tr>
            </thead>
            <tbody id="i_items"></tbody>
            <tfoot>
              <tr><td colspan="7" class="right">Subtotal</td><td class="right mono" id="i_subtotal">$0</td></tr>
              <tr><td colspan="7" class="right">Impuestos</td><td class="right mono" id="i_tax">$0</td></tr>
              <tr><td colspan="7" class="right">Descuentos</td><td class="right mono" id="i_disc">-$0</td></tr>
              <tr><td colspan="7" class="right">Total factura</td><td class="right mono" id="i_grand">$0</td></tr>
            </tfoot>
          </table>
        </div>
        <div class="small muted mt-2">Documento de demostraci√≥n (frontend). ‚ÄúSello rojo‚Äù solo decorativo.</div>
      </section>
    </div>

    <!-- html2pdf para exportar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

    <script is:inline>
      // ==== Utilidades ====
      const $ = (sel) => document.querySelector(sel);
      const money = (n) => new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 }).format(Number.isFinite(n)? n : 0);

      // ==== Productos din√°micos ====
      const body = $('#itemsBody');

      function addRow(defaults = {}) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="mono" type="number" min="1" value="${defaults.n || body.children.length+1}" style="width:100%"></td>
          <td><input type="text" value="${defaults.desc || ''}" placeholder="Descripci√≥n"></td>
          <td><input type="number" min="0" step="0.01" value="${defaults.qty ?? 1}"></td>
          <td><input type="text" value="${defaults.um || 'UN'}"></td>
          <td><input type="number" min="0" step="0.01" value="${defaults.price ?? 0}"></td>
          <td><input type="number" min="0" max="100" step="0.01" value="${defaults.tax ?? 0}"></td>
          <td><input type="number" min="0" max="100" step="0.01" value="${defaults.disc ?? 0}"></td>
          <td class="right mono totalCell">$0</td>
          <td class="right"><button class="btn danger btn-del">‚úï</button></td>
        `;
        body.appendChild(tr);
        tr.addEventListener('input', recalc);
        tr.querySelector('.btn-del').addEventListener('click', () => { tr.remove(); recalc(); });
        recalc();
      }

      $('#addRow').addEventListener('click', () => addRow());
      $('#clearRows').addEventListener('click', () => { body.innerHTML=''; recalc(); });

      // Arranque con una fila de ejemplo:
      addRow({ n:1, desc:'GUAYABERA', qty:1, um:'UN', price:30000, tax:0, disc:0 });

      // ==== C√°lculos ====
      function getRows() {
        return [...body.querySelectorAll('tr')].map(tr => {
          const [n, desc, qty, um, price, tax, disc] = [...tr.querySelectorAll('input')].map(i => i.type==='text' ? i.value : Number(i.value || 0));
          const base = qty * price;
          const taxAmt = base * (tax/100);
          const discAmt = base * (disc/100);
          const total = base + taxAmt - discAmt;
          return { n, desc, qty, um, price, tax, disc, base, taxAmt, discAmt, total, tr };
        });
      }

      function recalc() {
        const rows = getRows();
        let subtotal = 0, taxSum = 0, discSum = 0, grand = 0;
        rows.forEach(r => {
          subtotal += r.base; taxSum += r.taxAmt; discSum += r.discAmt; grand += r.total;
          r.tr.querySelector('.totalCell').textContent = money(r.total);
        });
        $('#subtotalCell').textContent = money(subtotal);
        $('#taxCell').textContent = money(taxSum);
        $('#discCell').textContent = `-${money(discSum).replace('$','')}`;
        $('#grandCell').textContent = money(grand);
      }

      // ==== ‚ÄúSincronizar‚Äù formulario -> vista factura ====
      function syncInvoice() {
        $('#i_rut').textContent = $('#rut').value || '‚Äî';
        $('#i_nombre').textContent = $('#nombre').value || '‚Äî';
        $('#i_correo').textContent = $('#correo').value || '‚Äî';
        $('#i_giro').textContent = $('#giro').value || '‚Äî';
        $('#i_fecha').textContent = $('#fechaEmision').value || '‚Äî';
        $('#i_pago').textContent = $('#formaPago').value || '‚Äî';

        const rows = getRows();
        const iBody = $('#i_items');
        iBody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="mono">${r.n}</td>
            <td>${r.desc || '‚Äî'}</td>
            <td class="mono">${r.qty}</td>
            <td>${r.um || ''}</td>
            <td class="mono">${money(r.price)}</td>
            <td class="mono">${r.tax}%</td>
            <td class="mono">${r.disc}%</td>
            <td class="right mono">${money(r.total)}</td>
          `;
          iBody.appendChild(tr);
        });

        // Totales
        $('#i_subtotal').textContent = $('#subtotalCell').textContent;
        $('#i_tax').textContent = $('#taxCell').textContent;
        $('#i_disc').textContent = $('#discCell').textContent;
        $('#i_grand').textContent = $('#grandCell').textContent;
      }

      // ==== Generar PDF ====
      $('#generatePdf').addEventListener('click', async () => {
        syncInvoice();
        const el = document.getElementById('invoice');
        const opt = {
          filename: `factura-${($('#rut').value || 'proveedor')}.pdf`,
          margin:       10,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        // Espera leve para asegurar fuentes/DOM listos
        setTimeout(() => html2pdf().from(el).set(opt).save(), 50);
      });

      // ==== Guardar borrador (ejemplo de futura integraci√≥n) ====
      $('#saveDraft').addEventListener('click', async () => {
        const payload = {
          proveedor: {
            rut: $('#rut').value, nombre: $('#nombre').value, correo: $('#correo').value,
            giro: $('#giro').value, fechaEmision: $('#fechaEmision').value, formaPago: $('#formaPago').value,
          },
          items: getRows().map(({n,desc,qty,um,price,tax,disc,total}) => ({ id:n, descripcion:desc, cantidad:qty, um, precio:price, impuesto:tax, descuento:disc, total })),
          totales: {
            subtotal: $('#subtotalCell').textContent, impuestos: $('#taxCell').textContent,
            descuentos: $('#discCell').textContent, total: $('#grandCell').textContent
          }
        };

        console.log('Borrador a enviar a API:', payload);
        alert('Esto enviar√° el borrador al backend cuando est√© disponible. Revisa la consola para ver el payload.');
        // TODO: conectar
        // await fetch('/api/facturas', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      });
    </script>
  </body>
</html>